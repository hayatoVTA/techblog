---
title: 'Cloud Run + Dockerã§React Appã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹'
date: 2021-10-24
tags: ['GCP', 'React', 'Google Cloud Run', 'Google Container Registry', 'docker', 'nginx']
draft: false
summary: 'Cloud Run + Dockerã§React Appã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹'
layout: PostSimple
---

JPYC æ ªå¼ä¼šç¤¾ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åƒã„ã¦ã„ã¾ã™ã€[@hayato_omr](https://twitter.com/hayato_omr)ã§ã™ã€‚
ä¼šç¤¾ã®æ¥­å‹™ã§ã‚‚ä½¿ã†ã“ã¨ã«ãªã£ãŸ Google Cloud Run ã‚’å°‘ã—è§¦ã£ã¦ã¿ãŸã®ã§ã–ã£ã¨å†…å®¹ã‚’æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚
åˆå¿ƒè€…ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãªã®ã§ãƒŸã‚¹ã£ã¦ãŸã‚Šã“ã“é•ã†ãã£ã¦éƒ¨åˆ†ãŒã‚ã‚Œã°æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ ğŸ‘€

## Google Cloud Run ã¨ã¯

![](https://storage.googleapis.com/zenn-user-upload/c38fb70fcc45651083bbd587.png)

> Cloud Run ã¯ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã•ã‚ŒãŸãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒã§ã™ã€‚
>
> Cloud Run ã¯ã€ãƒã‚·ãƒ³ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€ã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹æˆã€è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«ã¤ã„ã¦å¿ƒé…ã™ã‚‹ã“ã¨ãªãã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ HTTP ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç’°å¢ƒã§ã™ã€‚
>
> ref : https://cloud.google.com/blog/ja/topics/developers-practitioners/cloud-run-story-serverless-containers

ã¨ã®ã“ã¨ã§ã™ã€‚

ç°¡å˜ã«ã™ã‚‹ã¨ã‚ã¡ã‚ƒãã¡ã‚ƒç°¡å˜ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¦ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã‚ˆã¨ã„ã†ã“ã¨ã ã¨æ€ã„ã¾ã™ã€‚

è©³ã—ã„ã“ã¨ã¯[å…¬å¼ã® Developer Blog](https://cloud.google.com/blog/ja/topics/developers-practitioners/cloud-run-story-serverless-containers)ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

## å®Œæˆå½¢

ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ URL ã¯ã“ã‚“ãªæ„Ÿã˜
[https://react-gcr-xxxxxxxxxxx.a.run.app/](https://react-gcr-xxxxxxxxxxx.a.run.app/)
![](https://storage.googleapis.com/zenn-user-upload/ddd742877a07678bd2d9b983.png)

## æ§‹æˆ

- React
- Docker
- Google Container Registry
- Google Cloud Run

![](https://storage.googleapis.com/zenn-user-upload/62fe0449d7cd4f2fca3d962d.png)

## æœ¬ç·¨

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
react-gcr/
ã€€â”œ  .docker/
ã€€â”‚ã€€  â”œ  build/
ã€€â”‚ã€€  â”œ  Dockerfile
ã€€â”‚ã€€  â””  nginx.conf
ã€€â”œ  src/
ã€€â”‚ã€€  â””  ...
ã€€â””  ...
```

### CRA ã§ React ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã ã‘ãªã®ã§ JavaScript version ã§ä½œæˆã—ã¦ã¾ã™ã€‚

> Note: è‡ªåˆ†ã¯ npm ãŒå¥½ããªã®ã§è¨­å®šã—ã¦ã¾ã™ã€‚

```
$ npx create-react-app react-gcr --use-npm
```

### .docker ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® root ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€.docker ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚

### nginx ã® conf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

ä½œã£ã¦ã„ãã¾ã™ã€‚

```conf:.docker/nginx.conf
user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    # ãƒ‡ãƒ¼ã‚¿åœ§ç¸®
    gzip on;
    gzip_disable "msie6";

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

    brotli on;
    brotli_types text/plain text/css application/javascript application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    brotli_static on;

    server {
        listen 8080;

        root /usr/share/nginx/html;
        index index.html;

        server_name localhost;

        server_tokens off;

        location ~* \.(?:manifest|appcache|html?|xml|json)$ {
            expires -1;
        }

        location ~* \.(?:css|js)$ {
            try_files $uri =404;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        location ~ ^.+\..+$ {
            try_files $uri =404;
        }

        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
```

### Dockerfile ä½œæˆ

```dockerfile:.docker/Dockerfile
FROM node:12.16.3-alpine as build

WORKDIR /app

COPY . ./

FROM fholzer/nginx-brotli:v1.12.2

WORKDIR /etc/nginx
ADD nginx.conf /etc/nginx/nginx.conf

COPY --from=build /app/build /usr/share/nginx/html
EXPOSE 8080
CMD ["nginx", "-g", "daemon off;"]
```

### React App ã‚’ build

```
$ npm run build
```

ã§ããŸã‚‰ build ãƒ•ã‚©ãƒ«ãƒ€ã‚’ Dockerfile ã¨åŒã˜éšå±¤ã®`.docker/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã•ã›ã¦ãã ã•ã„ã€‚

### docker build

ãƒ­ãƒ¼ã‚«ãƒ«ã§ nginx+react ã‚’ç«‹ã¡ä¸Šã’ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã€‚

Note: `.docker/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„ã€‚

image ã‚’ä½œæˆ

```
$ docker build -t react-gcr-app ./ --no-cache=true
```

image ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

```
$ docker run -p 8080:8080 react-gcr-app
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§[http://localhost:8080](http://localhost:8080)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€React ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»é¢ãŒå‡ºã¦ã„ãŸã‚‰æˆåŠŸã§ã™ã€‚

### Google Container Registory ã« image ã‚’ push ã™ã‚‹

å‰ææ¡ä»¶:

- [Google Cloud SDK](https://cloud.google.com/sdk/docs/quickstart)ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒæ¸ˆã‚“ã§ã„ã‚‹
- Google Cloud Platform ã®èª²é‡‘ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹

ã¾ãšã¯ã€GCP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ç§»å‹•ã—ã€æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/9727d7f5cc8523fa43ac4a11.png)

ä½œæˆã§ããŸã‚‰ã€terminal ã«æˆ»ã£ã¦ docker ã® image ã‚’å†åº¦ build ã—ã¾ã™ã€‚
ãã®æ™‚ã€å…ˆã»ã©ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ id ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
react-gcr ã®ã¨ã“ã‚ã¯ä»»æ„ã®åå‰ã§ OK ã§ã™ã€‚

```
$ docker build -t gcr.io/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID/react-gcr ./
```

æ¬¡ã«ã€èªè¨¼ç³»ã§ã™ã€‚

> ref: [https://cloud.google.com/container-registry/docs/pushing-and-pulling](https://cloud.google.com/container-registry/docs/pushing-and-pulling)

```
$ gcloud login
```

```
$ gcloud auth configure-docker
```

ã‚ã¨ã¯ Google Container Registory ã«å…ˆã»ã©ä½œæˆã—ãŸ image ã‚’ push ã—ã¾ã™ã€‚
ã“ã®æ™‚ã®ã‚¿ã‚°ã¯å…ˆã»ã©ä½œæˆã—ãŸ image ã®ã‚¿ã‚°ã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

```
$ docker push gcr.io/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID/react-gcr
```

ã“ã“ã¾ã§é€²ã‚€ã¨ã“ã‚“ãªæ„Ÿã˜
![](https://storage.googleapis.com/zenn-user-upload/4c081ece721d0fab5decf8e5.png)

### Google Cloud Run ã« image ã‚’ Deploy

[Container Registory](https://console.cloud.google.com/gcr)ã‹ã‚‰ã€å…ˆã»ã©ä½œæˆã—ãŸ image ã‚’é¸æŠã—ã€Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5e4a9457183e76261a4a9ec4.png)

Step1 ã®ã‚µãƒ¼ãƒ“ã‚¹è¨­å®šã¯ãã®ã¾ã¾ã§ OKã€‚
Step2 ã¯æœªèªè¨¼ã‚’è¨±å¯ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãŠãã€‚
ã§ã€ä½œæˆã—ã¾ã™ã€‚

ä½œæˆã§ããŸã‚‰è‡ªå‹•çš„ã«ã‚µãƒ¼ãƒ“ã‚¹è©³ç´°ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã®ã§ã™ãŒã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®éš£ã® URL ã«[https://xxxx.a.run.app](https://xxxx.a.run.app)çš„ãªã‚‚ã®ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã“ã‚Œã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å…ˆã»ã© push ã—ãŸã‚¢ãƒ—ãƒªãŒã¿ã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

Cloud Run ã‚’ä½¿ã†ã¨ã‚ã¡ã‚ƒãã¡ã‚ƒç°¡å˜ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ãŸã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¡ã‚ƒã„ã¾ã™ã€‚

ã‚ã¨ã¯ Github Actions ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚è©¦ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ãã£ã¦ã„ã‚‹ã®ã§æˆåŠŸã—ãŸã‚‰ã¾ãŸè¨˜äº‹å‡ºã—ã¾ã™ã€‚

å‚è€ƒè¨˜äº‹
https://medium.com/swlh/deploying-a-react-app-to-google-cloud-run-with-github-actions-ae24ac6cb85a
https://cloud.google.com/container-registry/docs/pushing-and-pulling
https://cloud.google.com/blog/topics/developers-practitioners/cloud-run-story-serverless-containers
